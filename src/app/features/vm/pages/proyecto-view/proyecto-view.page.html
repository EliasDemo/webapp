<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4">
    <!-- CONTENIDO -->
    <ng-container *ngIf="!loading(); else loadingTpl">
      <ng-container *ngIf="!error() && proyecto(); else errorTpl">

        <!-- HEADER -->
        <div class="rounded-2xl border bg-white p-6 shadow-sm mb-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-2xl font-bold">{{ proyecto()?.titulo }}</h1>
                <span class="rounded-full px-2.5 py-1 text-xs font-semibold"
                      [ngClass]="estadoBadgeClassShared(proyecto()?.estado)">
                  {{ proyecto()?.estado }}
                </span>
              </div>
              <p class="text-gray-600 text-sm mt-1">
                Código: <b>{{ proyecto()?.codigo || '—' }}</b> ·
                Tipo: <b>{{ proyecto()?.tipo }}</b> ·
                Modalidad: <b>{{ proyecto()?.modalidad }}</b>
              </p>
            </div>

            <div class="flex flex-wrap gap-2 justify-end">
              <button (click)="handleRefresh()"
                      class="px-3 py-2 rounded-lg border hover:bg-gray-50 flex items-center gap-2">
                <i class="fa-solid fa-rotate-right"></i>
                <span>Refrescar</span>
              </button>

              <a [routerLink]="['/vm/proyectos', proyecto()?.id, 'registrantes']"
                 class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-2 shadow-sm"
                 title="Ver inscritos y candidatos del proyecto">
                <i class="fa-solid fa-users"></i>
                <span>Ver registrados</span>
              </a>

              <button *ngIf="proyecto()?.estado==='PLANIFICADO'"
                      (click)="handlePublish()"
                      class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                <i class="fa-solid fa-bullhorn mr-1"></i>
                Publicar
              </button>

              <button *ngIf="proyecto()?.estado==='PLANIFICADO'"
                      (click)="handleDelete()"
                      class="px-3 py-2 rounded-lg bg-red-50 text-red-700 border border-red-200 hover:bg-red-100">
                <i class="fa-solid fa-trash mr-1"></i>
                Eliminar
              </button>

              <a [routerLink]="['/vm/proyectos']"
                 class="px-3 py-2 rounded-lg border hover:bg-gray-50">
                <i class="fa-solid fa-arrow-left mr-1"></i>
                Volver
              </a>
            </div>
          </div>
        </div>

        <!-- HERO + KPIs -->
        <section class="overflow-hidden bg-white rounded-2xl border shadow-sm mb-6 py-8 sm:py-10">
          <div class="mx-auto max-w-7xl px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="lg:pr-8">
                <h2 class="text-base font-semibold text-indigo-600">Proyecto</h2>
                <p class="mt-2 text-3xl font-bold tracking-tight text-gray-900">
                  {{ proyecto()?.titulo }}
                </p>
                <p class="mt-4 text-gray-600">
                  {{ proyecto()?.descripcion || 'Sin descripción.' }}
                </p>

                <!-- KPIs -->
                <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <div class="rounded-xl border p-3 text-center">
                    <div class="text-xs text-gray-500">Procesos</div>
                    <div class="text-xl font-semibold">{{ procesos().length }}</div>
                  </div>
                  <div class="rounded-xl border p-3 text-center">
                    <div class="text-xs text-gray-500">Sesiones</div>
                    <div class="text-xl font-semibold">{{ totalSesiones() }}</div>
                  </div>
                  <div class="rounded-xl border p-3 text-center">
                    <div class="text-xs text-gray-500">Próximas</div>
                    <div class="text-xl font-semibold">{{ totalProximas() }}</div>
                  </div>
                  <div class="rounded-xl border p-3 text-center">
                    <div class="text-xs text-gray-500">Actuales</div>
                    <div class="text-xl font-semibold">{{ totalActuales() }}</div>
                  </div>
                </div>

                <!-- Metadatos -->
                <dl class="mt-6 space-y-3 text-sm text-gray-700">
                  <div class="flex gap-2">
                    <span class="w-40 font-semibold">Código</span>
                    <span>{{ proyecto()?.codigo || '—' }}</span>
                  </div>
                  <div class="flex gap-2">
                    <span class="w-40 font-semibold">Tipo / Modalidad</span>
                    <span>{{ proyecto()?.tipo }} · {{ proyecto()?.modalidad }}</span>
                  </div>
                  <div class="flex gap-2">
                    <span class="w-40 font-semibold">Nivel</span>
                    <span>{{ proyecto()?.nivel ?? '—' }}</span>
                  </div>
                  <div class="flex gap-2">
                    <span class="w-40 font-semibold">EP_SEDE / Período</span>
                    <span>{{ proyecto()?.ep_sede_id }} · {{ proyecto()?.periodo_id }}</span>
                  </div>
                  <div class="flex gap-2">
                    <span class="w-40 font-semibold">Horas planificadas</span>
                    <span>{{ proyecto()?.horas_planificadas }} h · mín. part.: {{ proyecto()?.horas_minimas_participante ?? '—' }}</span>
                  </div>
                </dl>
              </div>

              <!-- Portada -->
              <div class="relative">
                <img *ngIf="portadaUrl(); else noCover"
                     [src]="portadaUrl()!"
                     alt="Portada del proyecto"
                     class="w-full h-80 object-cover rounded-xl shadow ring-1 ring-gray-300">
                <ng-template #noCover>
                  <div class="w-full h-80 flex items-center justify-center rounded-xl bg-gray-100 ring-1 ring-gray-200 text-gray-500">
                    Sin imagen de portada
                  </div>
                </ng-template>

                <button *ngIf="isPlanificado()"
                        (click)="onEditProyectoDesignOnly()"
                        class="absolute top-3 right-3 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/90 border shadow hover:bg-white"
                        title="Editar portada (diseño)">
                  <i class="fa-solid fa-pen text-gray-700"></i>
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- GALERÍA -->
        <div class="rounded-2xl border bg-white p-6 shadow-sm mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Galería</h2>
            <span class="text-sm text-gray-500">{{ galeria().length }} imagen(es)</span>
          </div>

          <ng-container *ngIf="galeria().length; else noImgs">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              <div *ngFor="let img of galeria(); let i = index; trackBy: trackByIndex" class="relative group">
                <img [src]="img.url || ''" class="w-full h-40 object-cover rounded-lg border" alt="Imagen {{ i + 1 }}" />
                <button *ngIf="isPlanificado()"
                        (click)="onEditProyectoDesignOnly()"
                        class="absolute top-2 right-2 inline-flex h-8 w-8 items-center justify-center rounded-full bg-white/90 border shadow opacity-0 group-hover:opacity-100 transition"
                        title="Editar imagen (diseño)">
                  <i class="fa-solid fa-pen text-xs text-gray-700"></i>
                </button>
              </div>
            </div>
          </ng-container>
          <ng-template #noImgs>
            <p class="text-gray-500 text-sm">No hay imágenes adicionales.</p>
          </ng-template>
        </div>

        <!-- PROCESOS -->
        <div class="rounded-2xl border bg-white p-6 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Procesos</h2>
          </div>

          <!-- NOTA: el #noProc está FUERA del ngIf -->
          <ng-container *ngIf="procesos().length > 0; else noProc">
            <div class="space-y-6">
              <div *ngFor="let p of procesos(); trackBy: trackByProceso" class="relative">
                <div class="relative h-full">
                  <div class="relative h-full p-5 bg-white border rounded-2xl shadow-sm">
                    <!-- Editar proceso (diseño) -->
                    <button *ngIf="isPlanificado()"
                            (click)="onEditProcesoDesignOnly(p.id)"
                            class="absolute top-3 right-3 inline-flex h-9 w-9 items-center justify-center rounded-full bg-white/90 border shadow hover:bg-white"
                            title="Editar proceso (diseño)">
                      <i class="fa-solid fa-pen text-gray-700 text-sm"></i>
                    </button>

                    <!-- Header de proceso -->
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <h3 class="text-lg font-bold text-gray-800">{{ p.nombre }}</h3>
                        <span class="rounded-full px-2 py-0.5 text-[11px] font-semibold"
                              [ngClass]="estadoBadgeClassShared(p.estado)">
                          {{ p.estado || '—' }}
                        </span>
                      </div>
                    </div>

                    <p class="mt-1 text-gray-600">
                      Tipo: <b>{{ p.tipo_registro }}</b>
                      <span class="mx-1">·</span>
                      Horas asignadas: <b>{{ p.horas_asignadas || 0 }}</b>
                      <span *ngIf="p.sesiones?.length">
                        <span class="mx-1">·</span>
                        Sesiones: <b>{{ p.sesiones?.length }}</b>
                        <span class="mx-1">·</span>
                        Total sesiones: <b>{{ totalHorasSesionesByProceso(p) }} h</b>
                      </span>
                    </p>

                    <!-- SESIONES -->
                    <div class="mt-4">
                      <h4 class="font-semibold text-gray-800 mb-2">Sesiones</h4>

                      <ng-container *ngIf="p.sesiones?.length; else noSes">
                        <ol class="relative border-s pl-4 space-y-3">
                          <li *ngFor="let s of p.sesiones; trackBy: trackBySesion" class="ms-4">
                            <div class="absolute -start-1.5 mt-2 h-3 w-3 rounded-full"
                                [ngClass]="dotClass(relativoSesion(s))"></div>

                            <div class="rounded-md bg-white border p-3">
                              <div class="flex items-center justify-between gap-3">
                                <!-- Info principal -->
                                <div class="text-sm text-gray-700 flex items-center gap-2 flex-wrap">
                                  <span class="font-medium">{{ s.fecha }}</span>
                                  <span>· {{ horaRange(s) }}</span>
                                  <span>· {{ sesionHoras(s) }} h</span>

                                  <span class="rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                        [ngClass]="estadoBadgeClassShared(s.estado)">
                                    {{ s.estado || '—' }}
                                  </span>

                                  <span class="text-xs text-gray-500">({{ relativoSesion(s) }})</span>
                                </div>

                                <!-- Acciones -->
                                <div class="flex items-center gap-2">
                                  <a [routerLink]="['/vm/sesiones', s.id, 'asistencias']"
                                    class="px-2.5 py-1.5 text-xs rounded-md border bg-white hover:bg-gray-50 flex items-center gap-1"
                                    title="Ver asistencia">
                                    <i class="fa-solid fa-clipboard-check text-[11px]"></i>
                                    Asistencia
                                  </a>

                                  <!-- Excel (diseño / placeholder) -->
                                  <button type="button"
                                          (click)="exportarExcelSesionDesign(s.id)"
                                          class="px-2.5 py-1.5 text-xs rounded-md border bg-white hover:bg-gray-50 flex items-center gap-1"
                                          [disabled]="excelBusyId() === s.id">
                                    <i class="fa-solid" [ngClass]="excelBusyId()===s.id ? 'fa-spinner fa-spin' : 'fa-file-excel'"></i>
                                    <span *ngIf="excelBusyId() !== s.id">Reporte Excel</span>
                                    <span *ngIf="excelBusyId() === s.id">Generando…</span>
                                  </button>

                                  <!-- Editar (diseño) -->
                                  <button *ngIf="isPlanificado()"
                                          (click)="onEditSesionDesignOnly(p.id, s.id)"
                                          class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-white border shadow hover:bg-gray-50"
                                          title="Editar sesión (diseño)">
                                    <i class="fa-solid fa-pen text-xs text-gray-700"></i>
                                  </button>

                                  <!-- Toggle detalles -->
                                  <button (click)="toggleSesion(s.id)"
                                          class="inline-flex h-8 w-8 items-center justify-center rounded-full border hover:bg-gray-50"
                                          [attr.aria-expanded]="isSesionExpanded(s.id)">
                                    <i class="fa-solid" [ngClass]="isSesionExpanded(s.id) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                  </button>
                                </div>
                              </div>

                              <!-- Detalles -->
                              <div *ngIf="isSesionExpanded(s.id)" class="mt-3 text-xs text-gray-600 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1">
                                <div>Proyecto: <b>{{ proyecto()?.titulo }}</b> ({{ proyecto()?.codigo || '—' }})</div>
                                <div>Tipo/Modalidad: <b>{{ proyecto()?.tipo }}</b> · <b>{{ proyecto()?.modalidad }}</b></div>
                                <div>Nivel: <b>{{ proyecto()?.nivel ?? '—' }}</b></div>
                                <div>EP_SEDE / Período: <b>{{ proyecto()?.ep_sede_id }}</b> · <b>{{ proyecto()?.periodo_id }}</b></div>
                              </div>
                            </div>
                          </li>
                        </ol>
                      </ng-container>

                      <ng-template #noSes>
                        <p class="text-sm text-gray-500 mt-2">Sin sesiones.</p>
                      </ng-template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- TEMPLATE DEL ELSE (fuera del *ngIf) -->
          <ng-template #noProc>
            <p class="text-gray-500">Sin procesos aún.</p>
          </ng-template>
        </div>

      </ng-container>
    </ng-container>

    <!-- LOADING -->
    <ng-template #loadingTpl>
      <div class="flex justify-center items-center py-16">
        <div class="animate-spin rounded-full h-12 w-12 border-2 border-blue-600 border-t-transparent"></div>
      </div>
    </ng-template>

    <!-- ERROR -->
    <ng-template #errorTpl>
      <div class="bg-white rounded-2xl border border-red-200 p-8 text-center shadow-sm">
        <h3 class="text-lg font-semibold mb-2">Error al cargar el proyecto</h3>
        <p class="text-red-600 mb-6">{{ error() }}</p>
        <a routerLink="/vm/proyectos" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Volver a la lista</a>
      </div>
    </ng-template>
  </div>

  <!-- TOAST (diseño) -->
  <div *ngIf="toastMsg()" class="fixed bottom-4 right-4 z-50">
    <div class="flex items-center gap-3 rounded-xl bg-gray-900 text-white px-4 py-3 shadow-lg">
      <i class="fa-solid" [ngClass]="toastIcon()"></i>
      <div class="text-sm">{{ toastMsg() }}</div>
      <button (click)="closeToast()" class="ml-1 opacity-80 hover:opacity-100">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </div>
</div>
