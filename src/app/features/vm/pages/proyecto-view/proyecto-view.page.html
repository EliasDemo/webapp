<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/20 to-indigo-50/10 py-6">
  <div class="mx-auto max-w-7xl space-y-4 px-4">

    <!-- LOADING -->
    <ng-container *ngIf="loading(); else contentTpl">
      <div class="flex items-center justify-center py-20" role="status" aria-live="polite">
        <div class="text-center">
          <div class="relative mx-auto mb-3 h-12 w-12">
            <div class="h-12 w-12 rounded-full border-3 border-slate-200"></div>
            <div class="absolute inset-0 h-12 w-12 animate-spin rounded-full border-3 border-indigo-500 border-t-transparent"></div>
          </div>
          <p class="text-base font-semibold text-slate-700">Cargando proyecto…</p>
        </div>
      </div>
    </ng-container>

    <ng-template #contentTpl>

      <!-- ERROR -->
      <ng-container *ngIf="error(); else proyectoContentTpl">
        <div class="relative mx-auto max-w-2xl overflow-hidden rounded-xl border border-rose-200 bg-white p-8 text-center shadow-sm" role="alert" aria-live="assertive">
          <div class="relative">
            <div class="mx-auto mb-4 grid h-12 w-12 place-items-center rounded-xl bg-rose-100 text-rose-600">
              <i class="fa-solid fa-triangle-exclamation text-xl"></i>
            </div>
            <h3 class="mb-2 text-lg font-bold text-slate-900">Error al cargar el proyecto</h3>
            <p class="mb-5 text-sm font-semibold text-rose-700">{{ error() }}</p>
            <div class="flex justify-center gap-2">
              <a [routerLink]="['/vm/proyectos']" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:from-blue-700 hover:to-indigo-700">
                <i class="fa-solid fa-arrow-left"></i>
                Volver
              </a>
              <button (click)="handleRefresh()" class="inline-flex items-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition-colors hover:bg-slate-50">
                <i class="fa-solid fa-rotate"></i>
                Reintentar
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #proyectoContentTpl>
        <ng-container *ngIf="proyecto() as prj">

          <!-- HEADER -->
          <section class="relative overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">
            <div class="p-5">
              <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
                <!-- Info principal -->
                <div class="min-w-0 flex-1">
                  <div class="mb-3 flex flex-wrap items-center gap-2">
                    <h1 class="truncate text-2xl font-bold text-slate-900">
                      {{ prj.titulo }}
                    </h1>
                    <span class="inline-flex items-center gap-1 rounded-xl border px-2.5 py-1 text-xs font-semibold shadow-sm"
                          [ngClass]="estadoPillClasses(prj.estado)">
                      <i class="fa-solid fa-circle text-[6px] opacity-80"></i>{{ prj.estado }}
                    </span>
                  </div>

                  <!-- Metadatos -->
                  <div class="mb-3 flex flex-wrap items-center gap-3 text-sm text-slate-600">
                    <span class="inline-flex items-center gap-1">
                      <i class="fa-solid fa-hashtag text-blue-600"></i>
                      {{ prj.codigo || 'Sin código' }}
                    </span>
                    <span class="text-slate-400">•</span>
                    <span class="inline-flex items-center gap-1">
                      <i class="fa-solid fa-shapes text-purple-600"></i>
                      {{ prj.tipo }}
                    </span>
                    <span class="text-slate-400">•</span>
                    <span class="inline-flex items-center gap-1">
                      <i class="fa-solid fa-layer-group text-emerald-600"></i>
                      {{ prj.modalidad }}
                    </span>
                    <span class="text-slate-400">•</span>
                    <span class="inline-flex items-center gap-1">
                      <i class="fa-solid fa-clock text-amber-600"></i>
                      {{ prj.horas_planificadas }}h
                    </span>

                    <!-- Niveles (solo VINCULADO) -->
                    <ng-container *ngIf="nivelesTexto() as niv">
                      <span class="text-slate-400">•</span>
                      <span class="inline-flex items-center gap-1">
                        <i class="fa-solid fa-stairs text-pink-600"></i>
                        Niveles: {{ niv }}
                      </span>
                    </ng-container>
                  </div>

                  <p class="text-sm text-slate-700 line-clamp-2">
                    {{ prj.descripcion || 'Este proyecto aún no tiene una descripción.' }}
                  </p>
                </div>

                <!-- Portada -->
                <div class="w-full max-w-xs flex-shrink-0">
                  <div class="group relative">
                    <div class="relative overflow-hidden rounded-xl border border-slate-200 shadow-sm">
                      <img *ngIf="portadaUrl(); else noCover" [src]="portadaUrl()!" alt="Portada del proyecto"
                           class="h-40 w-full object-cover transition-transform duration-500" />
                      <ng-template #noCover>
                        <div class="grid h-40 w-full place-items-center rounded-xl bg-gradient-to-br from-slate-50 to-slate-100 text-slate-400">
                          <i class="fa-solid fa-image text-2xl"></i>
                        </div>
                      </ng-template>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Acciones -->
              <div class="mt-4 border-t border-slate-200 pt-4">
                <div class="flex flex-wrap gap-2">
                  <button (click)="handleRefresh()" class="inline-flex items-center gap-1 rounded-xl border border-indigo-200 bg-white px-3 py-1.5 text-xs font-semibold text-indigo-700 shadow-sm hover:border-indigo-300 hover:bg-indigo-50">
                    <i class="fa-solid fa-rotate"></i>
                    Refrescar
                  </button>

                  <a [routerLink]="['/vm/proyectos', prj.id, 'registrantes']"
                     class="inline-flex items-center gap-1 rounded-xl bg-gradient-to-r from-indigo-600 to-sky-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:from-indigo-700 hover:to-sky-700">
                    <i class="fa-solid fa-users"></i>
                    Registrados
                  </a>

                  <button *ngIf="canEditProyecto()" (click)="openProyectoEdit()"
                          class="inline-flex items-center gap-1 rounded-xl border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                    <i class="fa-solid fa-pen"></i>
                    Editar
                  </button>

                  <button *ngIf="prj.estado==='PLANIFICADO'" (click)="handlePublish()"
                          class="inline-flex items-center gap-1 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:from-emerald-700 hover:to-teal-700">
                    <i class="fa-solid fa-bullhorn"></i>
                    Publicar
                  </button>

                  <a [routerLink]="['/vm/proyectos']"
                     class="inline-flex items-center gap-1 rounded-xl border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                    <i class="fa-solid fa-arrow-left"></i>
                    Volver
                  </a>
                </div>
              </div>
            </div>
          </section>

          <!-- KPIs -->
          <section class="grid grid-cols-5 gap-3">
            <div class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-4 text-center shadow-sm">
              <div class="text-xl font-bold text-slate-900">{{ procesosSorted().length }}</div>
              <div class="text-xs font-semibold uppercase tracking-wider text-slate-500">Procesos</div>
            </div>
            <div class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-4 text-center shadow-sm">
              <div class="text-xl font-bold text-slate-900">{{ totalSesiones() }}</div>
              <div class="text-xs font-semibold uppercase tracking-wider text-slate-500">Sesiones</div>
            </div>
            <div class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-4 text-center shadow-sm">
              <div class="text-xl font-bold text-slate-900">{{ totalProximas() }}</div>
              <div class="text-xs font-semibold uppercase tracking-wider text-slate-500">Próximas</div>
            </div>
            <div class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-4 text-center shadow-sm">
              <div class="text-xl font-bold text-slate-900">{{ totalActuales() }}</div>
              <div class="text-xs font-semibold uppercase tracking-wider text-slate-500">En curso</div>
            </div>
            <div class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-4 text-center shadow-sm">
              <div class="text-xl font-bold text-slate-900">{{ totalPasadas() }}</div>
              <div class="text-xs font-semibold uppercase tracking-wider text-slate-500">Pasadas</div>
            </div>
          </section>

          <!-- GALERÍA -->
          <section class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <h2 class="flex items-center gap-2 text-lg font-bold text-slate-900">
                  <i class="fa-solid fa-images text-indigo-600"></i>
                  Galería
                </h2>
                <p class="mt-1 text-xs text-slate-600">{{ galeria().length }} imagen(es)</p>
              </div>
              <button *ngIf="canEditProyecto()" (click)="openProyectoEdit()"
                      class="inline-flex items-center gap-1 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:from-emerald-700 hover:to-teal-700">
                <i class="fa-solid fa-plus"></i>
                Añadir
              </button>
            </div>

            <ng-container *ngIf="galeria().length; else noImgs">
              <div class="grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6">
                <div *ngFor="let img of galeria(); let i = index; trackBy: trackByIndex" class="group relative">
                  <div class="relative overflow-hidden rounded-lg border border-slate-200">
                    <img [src]="img.url || ''" [alt]="'Imagen ' + (i + 1)"
                         class="h-24 w-full object-cover transition-transform duration-300 group-hover:scale-105" />
                    <div class="absolute left-1 top-1 rounded border border-white/30 bg-black/60 px-1.5 py-0.5 text-[10px] font-semibold text-white">#{{ i + 1 }}</div>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #noImgs>
              <div class="grid place-items-center rounded-xl border-2 border-dashed border-slate-300 bg-slate-50 py-8 text-center">
                <div class="mb-2 grid h-10 w-10 place-items-center rounded-lg bg-slate-100 text-slate-400">
                  <i class="fa-solid fa-images"></i>
                </div>
                <p class="text-sm text-slate-500">No hay imágenes en la galería</p>
              </div>
            </ng-template>
          </section>

          <!-- PROCESOS Y SESIONES -->
          <section class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <h2 class="flex items-center gap-2 text-lg font-bold text-slate-900">
                  <i class="fa-solid fa-diagram-project text-emerald-600"></i>
                  Procesos y sesiones
                </h2>
                <p class="mt-1 text-xs text-slate-600">{{ procesosSorted().length }} proceso(s) • {{ totalSesiones() }} sesiones</p>
              </div>
            </div>

            <ng-container *ngIf="procesosSorted().length > 0; else noProc">
              <div class="space-y-4">
                <div *ngFor="let p of procesosSorted(); trackBy: trackByProceso"
                     class="relative overflow-hidden rounded-xl border border-slate-200 bg-white p-4 shadow-sm">

                  <div class="mb-3 flex items-start justify-between">
                    <div class="flex-1">
                      <div class="mb-2 flex flex-wrap items-center gap-2">
                        <h3 class="text-base font-bold text-slate-900">{{ p.nombre }}</h3>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold border"
                              [ngClass]="estadoChipClass(p.estado)">
                          {{ p.estado || '—' }}
                        </span>
                      </div>

                      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-600">
                        <span class="inline-flex items-center gap-1">
                          <i class="fa-solid fa-tag text-purple-600"></i>{{ p.tipo_registro }}
                        </span>
                        <span class="text-slate-400">•</span>
                        <span class="inline-flex items-center gap-1">
                          <i class="fa-solid fa-clock text-amber-600"></i>{{ p.horas_asignadas || 0 }}h asignadas
                        </span>
                        <span *ngIf="p.sesiones?.length" class="text-slate-400">•</span>
                        <span *ngIf="p.sesiones?.length" class="inline-flex items-center gap-1">
                          <i class="fa-solid fa-calendar text-emerald-600"></i>{{ p.sesiones?.length }} sesiones
                        </span>
                      </div>

                      <!-- Progreso horas -->
                      <div class="mt-2">
                        <div class="h-1.5 w-full rounded bg-slate-200">
                          <div class="h-1.5 rounded bg-emerald-500" [style.width.%]="processProgressPct(p)"></div>
                        </div>
                        <div class="mt-1 text-[11px] text-slate-500">
                          {{ totalHorasSesionesByProceso(p) }}h de {{ p.horas_asignadas || 0 }}h planificadas ({{ processProgressPct(p) }}%)
                        </div>
                      </div>
                    </div>

                    <button *ngIf="canEditProceso(p)" (click)="openProcesoEdit(p.id)"
                            class="ml-2 inline-flex items-center gap-1 rounded-xl bg-gradient-to-r from-indigo-600 to-sky-600 px-2.5 py-1.5 text-xs font-semibold text-white shadow-sm hover:from-indigo-700 hover:to-sky-700">
                      <i class="fa-solid fa-pen"></i>
                      Editar
                    </button>
                  </div>

                  <!-- Sesiones -->
                  <div class="mt-3">
                    <ng-container *ngIf="p.sesiones?.length; else noSes">
                      <div class="space-y-2">
                        <div *ngFor="let s of p.sesiones; trackBy: trackBySesion"
                             class="group/sesion cursor-pointer rounded-lg border border-slate-200 bg-slate-50/50 px-3 py-2 transition-colors hover:border-indigo-200"
                             (click)="toggleSesion(s.id)">

                          <div class="flex items-center justify-between gap-2">
                            <div class="flex-1 min-w-0">
                              <div class="flex flex-wrap items-center gap-2 mb-1">
                                <span class="relative inline-flex h-2 w-2 rounded-full"
                                      [ngClass]="dotClass(relativoSesion(s))"></span>
                                <span class="text-sm font-semibold text-slate-900 truncate">{{ s.fecha }}</span>
                                <span class="text-xs text-slate-600">{{ horaRange(s) }}</span>
                                <span class="text-xs text-amber-700">{{ sesionHoras(s) }}h</span>
                              </div>
                              <div class="flex flex-wrap items-center gap-2 text-xs">
                                <span class="px-2 py-0.5 rounded-full font-semibold border"
                                      [ngClass]="estadoChipClass(s.estado)">{{ s.estado || '—' }}</span>
                                <span class="rounded-full bg-gradient-to-r from-indigo-600 to-cyan-600 px-2 py-0.5 text-[10px] font-bold text-white">
                                  {{ relativoSesion(s) | uppercase }}
                                </span>

                                <!-- (Opcional) Resumen de ciclos en fila -->
                                <ng-container *ngIf="sesionNiveles(s).length">
                                  <span class="inline-flex items-center gap-1">
                                    <i class="fa-solid fa-stairs text-pink-600"></i>
                                    <span class="text-slate-500">Ciclos:</span>
                                  </span>
                                  <span *ngFor="let n of sesionNiveles(s); trackBy: trackByIndex"
                                        class="rounded-full border border-pink-200 bg-pink-50 px-2 py-0.5 text-[10px] font-semibold text-pink-700">
                                    {{ n }}
                                  </span>
                                </ng-container>
                              </div>
                            </div>

                            <div class="flex items-center gap-1 ml-2" (click)="$event.stopPropagation()">
                              <a [routerLink]="['/vm/sesiones', s.id, 'asistencia']"
                                 class="inline-flex items-center gap-1 rounded-lg border border-emerald-200 bg-white px-2 py-1 text-xs font-semibold text-emerald-700 hover:border-emerald-300 hover:bg-emerald-50"
                                 title="Asistencias">
                                <i class="fa-solid fa-clipboard-check"></i>
                              </a>

                              <button type="button" (click)="exportarExcelSesion(s.id)" [disabled]="excelBusyId() === s.id"
                                      class="inline-flex items-center gap-1 rounded-lg border border-indigo-200 bg-white px-2 py-1 text-xs font-semibold text-indigo-700 hover:border-indigo-300 hover:bg-indigo-50 disabled:opacity-50"
                                      title="Descargar CSV">
                                <i class="fa-solid" [ngClass]="excelBusyId()===s.id ? 'fa-spinner fa-spin' : 'fa-download'"></i>
                              </button>

                              <button *ngIf="canEditSesion(s)" (click)="openSesionEdit(p.id, s.id)"
                                      class="inline-flex items-center gap-1 rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50"
                                      title="Editar sesión">
                                <i class="fa-solid fa-pen"></i>
                              </button>
                            </div>
                          </div>

                          <!-- Detalle expandible -->
                          <div *ngIf="isSesionExpanded(s.id)" class="mt-2 grid grid-cols-1 gap-2 text-xs text-slate-600">
                            <div *ngIf="s.lugar" class="inline-flex items-center gap-1">
                              <i class="fa-solid fa-location-dot text-slate-500"></i> {{ s.lugar }}
                            </div>
                            <div *ngIf="s.enlace" class="inline-flex items-center gap-1">
                              <i class="fa-solid fa-link text-slate-500"></i>
                              <a [href]="s.enlace" target="_blank" rel="noopener" class="underline">Enlace</a>
                            </div>
                            <div *ngIf="s.observacion" class="inline-flex items-center gap-1">
                              <i class="fa-solid fa-note-sticky text-slate-500"></i> {{ s.observacion }}
                            </div>

                            <!-- ✅ NUEVO: Ciclos -->
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <span class="inline-flex items-center gap-1">
                                <i class="fa-solid fa-stairs text-pink-600"></i>
                                <span class="font-semibold text-slate-700">Ciclos:</span>
                              </span>

                              <ng-container *ngIf="sesionNiveles(s).length; else noCiclosTpl">
                                <span *ngFor="let n of sesionNiveles(s); trackBy: trackByIndex"
                                      class="rounded-full border border-pink-200 bg-pink-50 px-2 py-0.5 text-[10px] font-semibold text-pink-700">
                                  {{ n }}
                                </span>
                              </ng-container>

                              <ng-template #noCiclosTpl>
                                <span class="text-[10px] text-slate-400">—</span>
                              </ng-template>

                              <span *ngIf="ciclosBusyId()===s.id" class="inline-flex items-center gap-1 text-[10px] text-slate-500">
                                <i class="fa-solid fa-spinner fa-spin"></i> Cargando…
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </ng-container>

                    <ng-template #noSes>
                      <div class="grid place-items-center rounded-lg border border-dashed border-slate-300 bg-slate-50 py-4 text-center">
                        <p class="text-xs text-slate-500">Sin sesiones programadas</p>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #noProc>
              <div class="grid place-items-center rounded-xl border-2 border-dashed border-slate-300 bg-slate-50 py-8 text-center">
                <p class="text-sm text-slate-500">Sin procesos configurados</p>
              </div>
            </ng-template>
          </section>
        </ng-container>
      </ng-template>
    </ng-template>

    <!-- TOAST -->
    <div *ngIf="toastMsg()" class="fixed bottom-4 right-4 z-50" aria-live="polite" role="status">
      <div class="flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900 px-3 py-2 text-white shadow-lg text-sm">
        <i class="fa-solid" [ngClass]="toastIcon()"></i>
        <div class="font-semibold">{{ toastMsg() }}</div>
        <button (click)="closeToast()" class="rounded-full p-1 hover:bg-white/10" aria-label="Cerrar aviso">
          <i class="fa-solid fa-xmark text-xs"></i>
        </button>
      </div>
    </div>

    <!-- MODALES -->
    <app-proyecto-edit-modal *ngIf="proyectoEditOpen() && proyecto()" [proyectoId]="proyecto()!.id" [initial]="proyecto()!" (saved)="onProyectoSaved()" (closed)="closeProyectoEdit()" />
    <app-proceso-edit-modal *ngIf="procesoEditing()" [procesoId]="procesoEditing()!.id" [initial]="procesoEditing()!" (saved)="onProcesoSaved()" (closed)="closeProcesoEdit()" />
    <app-sesion-edit-modal *ngIf="sesionEditing()" [sesionId]="sesionEditing()!.id" [initial]="sesionEditing()!" (saved)="onSesionSaved()" (closed)="closeSesionEdit()" />
  </div>
</div>
