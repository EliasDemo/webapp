<div class="min-h-screen bg-gradient-to-br from-slate-50 to-emerald-50/30 py-8">
  <div class="mx-auto max-w-7xl px-4">
    <!-- Header con efecto glassmorphism -->
    <div class="mb-10 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-white/60 shadow-emerald-100/50 transition-all duration-300 hover:shadow-emerald-200/70 hover:scale-105">
            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10m-10 4h10M5 21h14a2 2 0 002-2v-9a2 2 0 00-2-2H5a2 2 0 00-2 2v9a2 2 0 002 2z" />
            </svg>
          </div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-gray-900 to-emerald-700 bg-clip-text text-transparent">
            Historial de horas
          </h1>
        </div>
        <p class="text-gray-600 text-base font-medium flex items-center gap-2">
          <span class="w-2 h-2 bg-gradient-to-r from-emerald-500 to-teal-400 rounded-full animate-pulse"></span>
          Reporte de vinculación por períodos y proyectos
        </p>
      </div>

      <!-- Botón de ayuda/exportación -->
      <div class="flex gap-2">
        <button class="p-2 rounded-lg border border-gray-200 bg-white/80 backdrop-blur-sm hover:bg-white transition-all duration-300 hover:shadow-md">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </button>
        <button class="px-4 py-2 rounded-lg bg-white/80 backdrop-blur-sm border border-gray-200 hover:bg-white transition-all duration-300 hover:shadow-md flex items-center gap-2">
          <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <span class="text-sm font-medium">Exportar</span>
        </button>
      </div>
    </div>

    <!-- Filtros con mejoras visuales -->
    <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-white/60 p-4 mb-6 grid grid-cols-1 md:grid-cols-5 gap-3 shadow-sm transition-all duration-300 hover:shadow-md">
      <div class="flex flex-col">
        <label class="text-sm text-gray-600 mb-1 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Desde
        </label>
        <input type="date" class="border rounded-lg px-3 py-2 transition-all duration-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500"
               [ngModel]="params().desde ?? ''"
               (ngModelChange)="onFechaChange('desde', $event)" />
      </div>
      <div class="flex flex-col">
        <label class="text-sm text-gray-600 mb-1 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Hasta
        </label>
        <input type="date" class="border rounded-lg px-3 py-2 transition-all duration-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500"
               [ngModel]="params().hasta ?? ''"
               (ngModelChange)="onFechaChange('hasta', $event)" />
      </div>
      <div class="flex flex-col">
        <label class="text-sm text-gray-600 mb-1 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          Estado
        </label>
        <select class="border rounded-lg px-3 py-2 transition-all duration-300 focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500"
                [ngModel]="params().estado ?? ''"
                (ngModelChange)="onEstadoChange($event)">
          <option value="">Aprobados (por defecto)</option>
          <option value="*">Todos</option>
          <option value="APROBADO">Aprobado</option>
          <option value="PENDIENTE">Pendiente</option>
          <option value="ANULADO">Anulado</option>
        </select>
      </div>

      <div class="flex items-end gap-2 md:col-span-2">
        <button (click)="applyFilters()"
                class="px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-600 text-white hover:from-emerald-700 hover:to-teal-700 transition-all duration-300 shadow-sm hover:shadow-md flex items-center gap-2 group">
          <svg class="w-4 h-4 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z" />
          </svg>
          Aplicar filtros
        </button>
        <button (click)="clearFilters()"
                class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-md flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
          Limpiar
        </button>
      </div>
    </div>

    <!-- Total con diseño mejorado -->
    <div class="mb-6">
      <div class="bg-gradient-to-r from-white to-emerald-50/50 rounded-2xl border border-white/60 p-6 flex items-center justify-between shadow-sm backdrop-blur-sm transition-all duration-500 hover:shadow-lg">
        <div class="flex items-baseline gap-3">
          <div class="text-5xl font-extrabold leading-none bg-gradient-to-r from-gray-900 to-emerald-700 bg-clip-text text-transparent">{{ totalHoras() | number:'1.0-2' }}</div>
          <div class="text-gray-500 font-medium">horas acumuladas</div>
        </div>
        <div class="flex gap-3">
          <div class="px-3 py-2 bg-white/80 backdrop-blur-sm rounded-xl border border-white/60 transition-all duration-300 hover:scale-105">
            <div class="text-xs uppercase tracking-wide text-gray-500">Minutos</div>
            <div class="font-semibold text-gray-800">{{ totalMinutos() }}</div>
          </div>
          <div class="px-3 py-2 bg-white/80 backdrop-blur-sm rounded-xl border border-white/60 transition-all duration-300 hover:scale-105">
            <div class="text-xs uppercase tracking-wide text-gray-500">Períodos</div>
            <div class="font-semibold text-gray-800">{{ periodGroups().length }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mensaje de error mejorado -->
    <div *ngIf="errorMsg()" class="mb-6 p-4 rounded-xl bg-gradient-to-r from-red-50 to-red-100/50 text-red-700 border border-red-200 backdrop-blur-sm flex items-center gap-3 animate-pulse">
      <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{{ errorMsg() }}</span>
    </div>

    <!-- Lista por período con animaciones -->
    <ng-container *ngIf="!loading(); else loadingTpl">
      <ng-container *ngIf="periodGroups().length; else emptyTpl">
        <div class="space-y-4">
          <details *ngFor="let p of periodGroups(); trackBy: trackPeriod; let i = index"
                   class="bg-white/80 backdrop-blur-sm rounded-xl border border-white/60 overflow-hidden transition-all duration-500 hover:shadow-lg animate-fade-in"
                   [style.animation-delay]="(i * 100) + 'ms'">
            <summary class="cursor-pointer select-none p-4 flex items-center justify-between hover:bg-white/50 transition-all duration-300">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-emerald-100/50 rounded-lg transition-all duration-300 group-hover:bg-emerald-100">
                  <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <div class="font-semibold text-gray-800">
                    {{ p.codigo || 'Sin período' }}
                  </div>
                  <div class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      {{ p.horas | number:'1.0-2' }} h
                    </span>
                    <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                      </svg>
                      {{ p.proyectos.length }} proyectos
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-emerald-700 font-bold text-lg">
                  {{ p.horas | number:'1.0-2' }} h
                </div>
                <button (click)="verPeriodo(p.periodo_id); $event.preventDefault()"
                        [disabled]="!p.periodo_id"
                        class="px-3 py-1.5 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  Ver período
                </button>
              </div>
            </summary>

            <!-- Proyectos del período -->
            <div class="px-4 pb-4 border-t border-gray-100 mt-2 pt-4">
              <div class="divide-y divide-gray-100/70">
                <div *ngFor="let pr of p.proyectos; trackBy: trackProyecto"
                     class="py-3 flex items-start justify-between group hover:bg-white/50 rounded-lg px-3 -mx-3 transition-all duration-300">
                  <!-- Columna izquierda: info del proyecto -->
                  <div class="pr-6 flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <div class="font-semibold text-gray-800 group-hover:text-gray-900 transition-colors duration-300">{{ pr.titulo || 'Proyecto' }}</div>
                      <span class="text-xs px-2 py-0.5 rounded-full font-medium transition-all duration-300"
                            [class.bg-red-100]="pr.estado==='CERRADO' || pr.estado==='CANCELADO'"
                            [class.text-red-800]="pr.estado==='CERRADO' || pr.estado==='CANCELADO'"
                            [class.bg-indigo-100]="pr.estado!=='CERRADO' && pr.estado!=='CANCELADO'"
                            [class.text-indigo-800]="pr.estado!=='CERRADO' && pr.estado!=='CANCELADO'">
                        {{ pr.estado || '—' }}
                      </span>
                    </div>
                    <div class="text-sm text-gray-500 flex items-center gap-2">
                      <span>{{ pr.tipo_proyecto || '—' }}</span>
                      <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                      <span>{{ pr.modalidad || '—' }}</span>
                    </div>
                  </div>

                  <!-- Columna derecha: totales + barra -->
                  <div class="text-right shrink-0 w-72">
                    <div class="font-bold text-lg text-gray-800">{{ pr.horas | number:'1.0-2' }} h</div>

                    <!-- Si hay plan, muestro "de X h planificadas" -->
                    <div class="text-xs text-gray-500 mt-1" *ngIf="pr.plan_horas != null">
                      de {{ pr.plan_horas | number:'1.0-2' }} h planificadas
                    </div>

                    <!-- Barra de progreso -->
                    <div class="mt-2 h-2.5 w-full rounded-full overflow-hidden border border-white shadow-inner"
                        [ngClass]="barBgClass(pr)">
                      <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-400 transition-all duration-1000 ease-out"
                          [ngStyle]="{ width: (percentDone(pr) > 100 ? 100 : percentDone(pr)) + '%' }">
                      </div>
                    </div>

                    <!-- Leyendas faltantes / extra -->
                    <div class="mt-1 text-xs flex flex-wrap justify-end gap-1">
                      <span class="text-emerald-700 font-semibold bg-emerald-50 px-1.5 py-0.5 rounded">
                        {{ pr.horas | number:'1.0-2' }} h realizadas
                      </span>
                      <span *ngIf="pr.plan_horas != null && missingHours(pr) > 0"
                            [ngClass]="{
                              'text-yellow-700 bg-yellow-50 px-1.5 py-0.5 rounded': pr.estado!=='CERRADO' && pr.estado!=='CANCELADO',
                              'text-red-700 bg-red-50 px-1.5 py-0.5 rounded': pr.estado==='CERRADO' || pr.estado==='CANCELADO'
                            }">
                        faltan {{ missingHours(pr) | number:'1.0-2' }} h
                      </span>
                      <span *ngIf="hasExtra(pr)" class="text-teal-700 bg-teal-50 px-1.5 py-0.5 rounded">
                        extra {{ extraHours(pr) | number:'1.0-2' }} h
                      </span>
                      <span *ngIf="pr.plan_horas == null" class="text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">
                        sin plan definido
                      </span>
                    </div>

                    <a [routerLink]="verProyectoUrl(pr.id)"
                      class="inline-block mt-2 text-sm text-emerald-700 hover:text-emerald-800 font-medium transition-all duration-300 hover:underline flex items-center gap-1 justify-end">
                      Ver detalles
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </div>

        <!-- Paginación mejorada -->
        <div class="text-center mt-8" *ngIf="meta() && meta()!.current_page < meta()!.last_page">
          <button (click)="loadMore()"
                  class="px-6 py-3 rounded-xl bg-gradient-to-r from-slate-800 to-slate-700 text-white hover:from-slate-900 hover:to-slate-800 disabled:opacity-60 transition-all duration-300 shadow-md hover:shadow-lg flex items-center gap-2 mx-auto group"
                  [disabled]="loadingMore()">
            <span *ngIf="!loadingMore(); else spinner" class="flex items-center gap-2">
              <svg class="w-4 h-4 group-hover:translate-y-0.5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
              </svg>
              Cargar más
            </span>
            <ng-template #spinner>
              <span class="inline-flex items-center gap-2">
                <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                Cargando…
              </span>
            </ng-template>
          </button>
          <p class="text-xs text-gray-500 mt-2">
            Página {{ meta()?.current_page }} de {{ meta()?.last_page }}
          </p>
        </div>
      </ng-container>
    </ng-container>

    <!-- Loading mejorado -->
    <ng-template #loadingTpl>
      <div class="flex flex-col justify-center items-center py-20 bg-white/80 backdrop-blur-sm rounded-2xl border border-white/60">
        <div class="relative">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-emerald-600"></div>
          <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
        <p class="mt-4 text-gray-600 font-medium">Cargando historial de horas...</p>
      </div>
    </ng-template>

    <!-- Estado vacío mejorado -->
    <ng-template #emptyTpl>
      <div class="text-center py-20 bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm border border-white/60 transition-all duration-500 hover:shadow-md">
        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-emerald-100 to-teal-100 flex items-center justify-center">
          <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2 text-gray-800">No hay registros de horas</h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">No se encontraron registros de horas con los filtros actuales. Prueba ajustando los filtros o selecciona otro rango de fechas.</p>
        <button (click)="clearFilters()"
                class="px-6 py-2.5 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-600 text-white hover:from-emerald-700 hover:to-teal-700 transition-all duration-300 shadow-sm hover:shadow-md inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Limpiar filtros
        </button>
      </div>
    </ng-template>
  </div>
</div>
