<div class="p-4 lg:p-6 max-w-4xl mx-auto">
  <div class="flex items-center gap-3 mb-4">
    <h1 class="text-xl font-semibold">Registrar asistencia por QR</h1>
    <span class="text-xs text-slate-500 ml-auto">
      Sesión #{{ sesionId() || '—' }}
    </span>
  </div>

  <!-- Mensajes -->
  <ng-container *ngIf="error()">
    <div class="p-3 rounded bg-rose-50 text-rose-700 border border-rose-200 mb-4">
      {{ error() }}
    </div>
  </ng-container>

  <ng-container *ngIf="info() && !error()">
    <div class="p-3 rounded bg-amber-50 text-amber-800 border border-amber-200 mb-4">
      {{ info() }}
    </div>
  </ng-container>

  <!-- Éxito -->
  <section *ngIf="success(); else scannerBlock" class="rounded-xl border bg-white shadow-sm p-4">
    <h2 class="text-sm font-semibold text-emerald-700 mb-2">¡Asistencia registrada!</h2>
    <p class="text-sm text-slate-700 mb-2">
      Check-in: <b>{{ success()?.asistencia?.check_in_at | date:'short' }}</b>
    </p>
    <p class="text-xs text-slate-500">
      La ventana de QR cierra: <b>{{ success()?.ventana_fin | date:'short' }}</b>
    </p>
    <div class="mt-4 flex gap-2">
      <button class="px-3 py-1.5 rounded border" (click)="reset()">Registrar otro</button>
    </div>
  </section>

  <!-- Escáner -->
  <ng-template #scannerBlock>
    <section class="rounded-xl border bg-white shadow-sm p-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Cámara y escáner -->
        <div class="lg:col-span-2">
          <div class="aspect-video w-full bg-black/5 rounded-lg overflow-hidden border">
            <zxing-scanner
              [device]="selectedDevice() || undefined"
              [enable]="mayScan()"
              [tryHarder]="true"
              [timeBetweenScans]="1500"
              (camerasFound)="onCamerasFound($event)"
              (camerasNotFound)="onCamerasNotFound()"
              (permissionResponse)="onPermissionResponse($event)"
              (scanSuccess)="onScanSuccess($event)"
            ></zxing-scanner>
          </div>

          <div class="mt-3 flex flex-wrap items-center gap-2">
            <label class="text-xs text-slate-600">Cámara:</label>
            <select
              class="border rounded px-2 py-1 text-sm"
              [disabled]="!cameras().length"
              (change)="onDeviceChange($event)"
            >
              <option *ngFor="let c of cameras(); let i=index" [selected]="c === selectedDevice()">
                {{ c.label || ('Cámara ' + (i+1)) }}
              </option>
            </select>

            <label class="ml-4 inline-flex items-center gap-2 text-xs">
              <input type="checkbox" class="accent-indigo-600" [checked]="useGeo()" (change)="useGeo.set($any($event.target).checked)" />
              Usar ubicación (si el QR la exige)
            </label>

            <span class="ml-auto text-xs text-slate-500" *ngIf="hasPermission() === false">
              La cámara está bloqueada por permisos.
            </span>
          </div>

          <div *ngIf="coords()" class="mt-2 text-xs text-slate-600">
            Posición capturada: {{ coords()?.lat }} , {{ coords()?.lng }}
          </div>
          <div *ngIf="geoError()" class="mt-2 text-xs text-rose-600">
            {{ geoError() }}
          </div>
        </div>

        <!-- Registro manual / estado -->
        <div class="lg:col-span-1">
          <div class="space-y-3">
            <label class="block text-sm text-slate-700">Contenido del QR / Token</label>
            <input
              [formControl]="token"
              class="w-full border rounded-lg px-3 py-2"
              placeholder="Pega aquí lo leído (token, URL o JSON)"
            />
            <div class="flex gap-2">
              <button
                class="px-3 py-1.5 rounded border border-indigo-300 bg-indigo-50 hover:bg-indigo-100 disabled:opacity-50"
                [disabled]="!token.value || loading()"
                (click)="registrarManual()"
              >
                Registrar
              </button>
              <button class="px-3 py-1.5 rounded border" (click)="reset()" [disabled]="loading()">Limpiar</button>
            </div>

            <div class="text-xs text-slate-500">
              Consejo: si el escáner no enfoca, pega el contenido del QR en el campo y presiona Registrar.
            </div>

            <div *ngIf="loading()" class="text-sm text-slate-600">
              Registrando asistencia…
            </div>
          </div>
        </div>
      </div>
    </section>
  </ng-template>
</div>
